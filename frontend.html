<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ML Researcher LangGraph - Frontend</title>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="https://unpkg.com/axios/dist/axios.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        .gradient-bg {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }
        .card-shadow {
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
        }
        .workflow-badge {
            @apply inline-flex items-center px-3 py-1 rounded-full text-sm font-medium;
        }
        .model-suggestion { @apply bg-green-100 text-green-800; }
        .research-planning { @apply bg-purple-100 text-purple-800; }
        .direct-llm { @apply bg-blue-100 text-blue-800; }
        .unknown { @apply bg-gray-100 text-gray-800; }
        
        .result-animation {
            animation: slideInUp 0.5s ease-out;
        }
        
        @keyframes slideInUp {
            from {
                transform: translateY(30px);
                opacity: 0;
            }
            to {
                transform: translateY(0);
                opacity: 1;
            }
        }
        
        .spinner {
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }

        .code-block {
            background: #1f2937;
            color: #f9fafb;
            border-radius: 0.5rem;
            padding: 1rem;
            font-family: 'Courier New', monospace;
            font-size: 0.875rem;
            overflow-x: auto;
        }
        
        /* Custom prose styling for markdown content */
        .prose h1, .prose h2, .prose h3, .prose h4 {
            color: #374151;
            font-weight: 600;
            margin-top: 1.5rem;
            margin-bottom: 0.5rem;
        }
        
        .prose h3 {
            font-size: 1.25rem;
            border-bottom: 2px solid #e5e7eb;
            padding-bottom: 0.5rem;
        }
        
        .prose ul, .prose ol {
            margin: 1rem 0;
            padding-left: 1.5rem;
        }
        
        .prose li {
            margin: 0.5rem 0;
        }
        
        .prose p {
            margin: 1rem 0;
            line-height: 1.6;
        }
        
        .prose strong {
            font-weight: 600;
            color: #1f2937;
        }
        
        .prose em {
            font-style: italic;
            color: #4b5563;
        }
        
        .prose code {
            background: #f3f4f6;
            padding: 0.2rem 0.4rem;
            border-radius: 0.25rem;
            font-size: 0.875rem;
        }

        .status-indicator {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            display: inline-block;
            margin-right: 0.5rem;
        }

        .status-online { background-color: #10b981; }
        .status-offline { background-color: #ef4444; }
        .status-connecting { background-color: #f59e0b; animation: pulse 2s infinite; }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        .terminal-output {
            background: #000;
            color: #00ff00;
            font-family: 'Courier New', monospace;
            padding: 1rem;
            border-radius: 0.5rem;
            max-height: 400px;
            overflow-y: auto;
            white-space: pre-wrap;
        }

        /* Enhanced Experiment Suggestions Styling */
        .experiment-suggestions-content h1 {
            color: #1e40af;
            border-bottom: 3px solid #3b82f6;
            padding-bottom: 0.5rem;
            margin-bottom: 1.5rem;
            font-size: 1.875rem;
            font-weight: 700;
        }

        .experiment-suggestions-content h2 {
            color: #1f2937;
            background: linear-gradient(135deg, #f3f4f6 0%, #e5e7eb 100%);
            padding: 0.75rem 1rem;
            border-left: 4px solid #3b82f6;
            border-radius: 0.5rem;
            margin: 2rem 0 1rem 0;
            font-size: 1.5rem;
            font-weight: 600;
            position: relative;
        }

        .experiment-suggestions-content h2::before {
            content: '';
            position: absolute;
            left: -4px;
            top: 0;
            bottom: 0;
            width: 4px;
            background: linear-gradient(to bottom, #3b82f6, #1d4ed8);
        }

        .experiment-suggestions-content h3 {
            color: #374151;
            font-size: 1.25rem;
            font-weight: 600;
            margin: 1.5rem 0 0.75rem 0;
            padding: 0.5rem 0.75rem;
            background: #f9fafb;
            border-left: 3px solid #6366f1;
            border-radius: 0.25rem;
        }

        .experiment-suggestions-content h4 {
            color: #4b5563;
            font-size: 1.125rem;
            font-weight: 500;
            margin: 1rem 0 0.5rem 0;
            padding-left: 0.5rem;
            border-left: 2px solid #d1d5db;
        }

        .experiment-suggestions-content ul {
            margin: 1rem 0;
            padding-left: 2rem;
        }

        .experiment-suggestions-content li {
            margin: 0.75rem 0;
            line-height: 1.7;
            position: relative;
        }

        .experiment-suggestions-content li::marker {
            color: #3b82f6;
            font-weight: bold;
        }

        .experiment-suggestions-content strong {
            color: #1f2937;
            font-weight: 700;
            background: linear-gradient(120deg, #dbeafe, transparent);
            padding: 0.125rem 0.25rem;
            border-radius: 0.25rem;
        }

        .experiment-suggestions-content p {
            margin: 1rem 0;
            line-height: 1.8;
            color: #374151;
        }

        .experiment-suggestions-content blockquote {
            border-left: 4px solid #fbbf24;
            background: #fffbeb;
            padding: 1rem 1.5rem;
            margin: 1.5rem 0;
            border-radius: 0.5rem;
            font-style: italic;
            color: #92400e;
        }

        .experiment-suggestions-content code {
            background: #f1f5f9;
            color: #475569;
            padding: 0.25rem 0.5rem;
            border-radius: 0.375rem;
            font-size: 0.875rem;
            border: 1px solid #e2e8f0;
        }

        .experiment-suggestions-content pre {
            background: #1e293b;
            color: #f8fafc;
            padding: 1.5rem;
            border-radius: 0.75rem;
            overflow-x: auto;
            margin: 1.5rem 0;
            border: 1px solid #334155;
        }

        .experiment-suggestions-content pre code {
            background: none;
            color: inherit;
            border: none;
            padding: 0;
        }

        .experiment-suggestions-content table {
            width: 100%;
            border-collapse: collapse;
            margin: 1.5rem 0;
            background: white;
            border-radius: 0.5rem;
            overflow: hidden;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        }

        .experiment-suggestions-content th {
            background: #3b82f6;
            color: white;
            padding: 0.75rem;
            text-align: left;
            font-weight: 600;
        }

        .experiment-suggestions-content td {
            padding: 0.75rem;
            border-bottom: 1px solid #e5e7eb;
        }

        .experiment-suggestions-content tr:hover {
            background: #f9fafb;
        }

        /* Special formatting for implementation phases */
        .experiment-suggestions-content h3:contains("Phase") {
            background: linear-gradient(135deg, #ddd6fe 0%, #c4b5fd 100%);
            border-left-color: #8b5cf6;
            color: #5b21b6;
        }

        /* Priority experiment highlighting */
        .experiment-suggestions-content li:contains("Priority") {
            background: linear-gradient(120deg, #ecfdf5, transparent);
            padding: 0.5rem;
            border-left: 3px solid #10b981;
            border-radius: 0.25rem;
            margin: 1rem 0;
        }

        /* Risk level indicators */
        .experiment-suggestions-content strong:contains("Low") {
            background: linear-gradient(120deg, #dcfce7, transparent);
            color: #166534;
        }

        .experiment-suggestions-content strong:contains("Medium") {
            background: linear-gradient(120deg, #fef3c7, transparent);
            color: #92400e;
        }

        .experiment-suggestions-content strong:contains("High") {
            background: linear-gradient(120deg, #fee2e2, transparent);
            color: #991b1b;
        }

        /* removed workflow diagram styles */
    </style>
</head>
<body class="bg-gray-50">
    <div id="app">
        <!-- Header -->
        <header class="gradient-bg text-white shadow-lg">
            <div class="container mx-auto px-4 py-4">
                <div class="flex items-center justify-between">
                    <div class="flex items-center space-x-3">
                        <i class="fas fa-microscope text-3xl"></i>
                        <div>
                            <h1 class="text-3xl font-bold">ML Researcher LangGraph</h1>
                            <p class="text-purple-200">AI-powered research assistant with multi-workflow orchestration</p>
                        </div>
                    </div>
                    <div class="flex items-center space-x-4">
                        <div class="flex items-center">
                            <span :class="'status-indicator ' + connectionStatus"></span>
                            <span class="text-sm">{{ connectionMessage }}</span>
                        </div>
                        <button 
                            @click="showSettings = !showSettings"
                            class="p-2 rounded-lg bg-white bg-opacity-20 hover:bg-opacity-30"
                        >
                            <i class="fas fa-cog"></i>
                        </button>
                    </div>
                </div>
            </div>
        </header>

        <!-- Settings Panel -->
        <div v-if="showSettings" class="bg-white border-b shadow-sm">
            <div class="container mx-auto px-4 py-4">
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Backend URL</label>
                        <input 
                            v-model="backendUrl" 
                            type="url" 
                            placeholder="http://localhost:8000"
                            class="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-purple-500 focus:border-purple-500"
                        >
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Mode</label>
                        <select v-model="operationMode" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-purple-500 focus:border-purple-500">
                            <option value="api">API Mode</option>
                            <option value="demo">Demo Mode</option>
                        </select>
                    </div>
                    <div class="flex items-end">
                        <button 
                            @click="testConnection"
                            class="px-4 py-2 bg-purple-600 text-white rounded-md hover:bg-purple-700"
                        >
                            <i class="fas fa-plug mr-1"></i>
                            Test Connection
                        </button>
                    </div>
                </div>
            </div>
        </div>

        

        <!-- Main Content -->
    <main class="container mx-auto px-4 mt-6">
            <!-- Input Section -->
            <div class="card-shadow bg-white rounded-lg p-6 mb-6">
                <h2 class="text-2xl font-bold text-gray-800 mb-4">
                    <i class="fas fa-search mr-2"></i>
                    Research Task Analysis
                </h2>
                
                <!-- Example Prompts -->
                <div class="mb-4">
                    <h3 class="text-lg font-medium text-gray-700 mb-2">Example Prompts:</h3>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-2">
                        <button 
                            v-for="example in examplePrompts"
                            :key="example.text"
                            @click="prompt = example.text"
                            class="text-left p-3 bg-gray-50 rounded-lg hover:bg-gray-100 border border-gray-200"
                        >
                            <div class="flex items-center mb-1">
                                <i :class="example.icon + ' mr-2 text-' + example.color + '-600'"></i>
                                <span class="font-medium text-gray-800">{{ example.title }}</span>
                            </div>
                            <p class="text-sm text-gray-600">{{ example.text.substring(0, 100) }}...</p>
                        </button>
                    </div>
                </div>
                
                <div class="space-y-4">
                    <textarea
                        v-model="prompt"
                        @keydown.ctrl.enter="analyzeTask"
                        placeholder="Enter your machine learning research task or question here..."
                        class="w-full h-32 p-4 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent resize-none"
                        :disabled="isAnalyzing"
                    ></textarea>
                    
                    <!-- File Uploads -->
                    <div class="bg-gray-50 border border-gray-200 rounded-lg p-3">
                        <div class="flex items-center justify-between">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Attach files (DOCX, CSV, XLSX)</label>
                                <input 
                                    type="file"
                                    multiple
                                    :disabled="isAnalyzing"
                                    @change="onFilesSelected"
                                    accept=".doc,.docx,.csv,.xlsx,.xls"
                                    class="block w-full text-sm text-gray-600 file:mr-4 file:py-2 file:px-4 file:rounded file:border-0 file:text-sm file:font-semibold file:bg-purple-50 file:text-purple-700 hover:file:bg-purple-100"
                                />
                            </div>
                            <button v-if="uploadedFiles.length"
                                @click="clearFiles"
                                class="h-9 px-3 text-sm text-gray-600 border border-gray-300 rounded hover:bg-gray-100"
                                :disabled="isAnalyzing"
                            >Clear files ({{ uploadedFiles.length }})</button>
                        </div>
                        <div v-if="uploadedFiles.length" class="mt-2 text-sm text-gray-700">
                            <ul class="list-disc pl-5 space-y-1 max-h-28 overflow-y-auto">
                                <li v-for="(f, i) in uploadedFiles" :key="i">{{ f.name }} <span class="text-gray-400">({{ (f.size/1024).toFixed(1) }} KB)</span></li>
                            </ul>
                        </div>
                    </div>
                    
                    <div class="flex items-center justify-between">
                        <div class="flex items-center space-x-4">
                            <label class="flex items-center">
                                <input type="checkbox" v-model="streamMode" class="mr-2">
                                <span class="text-sm text-gray-600">Stream results</span>
                            </label>
                            <label class="flex items-center">
                                <input type="checkbox" v-model="verboseMode" class="mr-2">
                                <span class="text-sm text-gray-600">Verbose output</span>
                            </label>
                        </div>
                        
                        <div class="flex space-x-2">
                            <button
                                @click="clearAll"
                                class="px-4 py-2 text-gray-600 border border-gray-300 rounded-lg hover:bg-gray-50"
                            >
                                <i class="fas fa-trash mr-1"></i>
                                Clear
                            </button>
                            <button
                                @click="analyzeTask"
                                :disabled="!prompt.trim() || isAnalyzing"
                                class="px-6 py-2 bg-purple-600 text-white rounded-lg hover:bg-purple-700 disabled:opacity-50 disabled:cursor-not-allowed flex items-center space-x-2"
                            >
                                <i class="fas fa-spinner spinner" v-if="isAnalyzing"></i>
                                <i class="fas fa-play" v-else></i>
                                <span>{{ isAnalyzing ? 'Analyzing...' : 'Analyze Task' }}</span>
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Progress/Status Section -->
            <div v-if="isAnalyzing || analysisLog.length > 0" class="card-shadow bg-white rounded-lg p-6 mb-6">
                <h3 class="text-lg font-bold text-gray-800 mb-4">
                    <i class="fas fa-terminal mr-2"></i>
                    Analysis Progress
                </h3>
                <div class="terminal-output">
                    <div v-for="(log, index) in analysisLog" :key="index">
                        {{ log }}
                    </div>
                    <span v-if="isAnalyzing" class="animate-pulse">â–ˆ</span>
                </div>
            </div>

            <!-- Results Section -->
            <div v-if="analysisResult" class="result-animation card-shadow bg-white rounded-lg p-6 mb-6">
                <div class="flex items-center justify-between mb-6">
                    <h2 class="text-2xl font-bold text-gray-800">
                        <i class="fas fa-chart-bar mr-2"></i>
                        Analysis Results
                    </h2>
                    <div class="flex items-center space-x-2">
                        <span :class="'workflow-badge ' + getWorkflowClass(analysisResult.workflow_type)">
                            <i :class="getWorkflowIcon(analysisResult.workflow_type) + ' mr-1'"></i>
                            {{ analysisResult.workflow_type.replace('_', ' ').toUpperCase() }}
                        </span>
                        <span class="text-sm text-gray-500" v-if="analysisResult.processing_time">
                            {{ formatProcessingTime(analysisResult.processing_time) }}
                        </span>
                    </div>
                </div>

                <!-- Router Decision -->
                <div class="bg-gray-50 rounded-lg p-4 mb-6" v-if="analysisResult.router_decision">
                    <h3 class="font-semibold text-gray-800 mb-3">
                        <i class="fas fa-route mr-2"></i>
                        Router Decision
                    </h3>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                        <div v-if="analysisResult.router_decision.confidence">
                            <span class="text-sm text-gray-600">Confidence:</span>
                            <div class="font-mono text-lg">{{ (analysisResult.router_decision.confidence * 100).toFixed(1) }}%</div>
                        </div>
                        <div class="md:col-span-2" v-if="analysisResult.router_decision.reasoning">
                            <span class="text-sm text-gray-600">Reasoning:</span>
                            <div class="text-gray-800">{{ analysisResult.router_decision.reasoning }}</div>
                        </div>
                    </div>
                </div>

                <!-- Results Content Tabs -->
                <div class="mb-6">
                    <div class="flex border-b border-gray-200">
                        <button
                            v-for="tab in availableTabs"
                            :key="tab.key"
                            @click="activeTab = tab.key"
                            :class="[
                                'px-4 py-2 font-medium text-sm border-b-2 transition-colors',
                                activeTab === tab.key 
                                    ? 'border-purple-500 text-purple-600' 
                                    : 'border-transparent text-gray-500 hover:text-gray-700'
                            ]"
                        >
                            <i :class="tab.icon + ' mr-2'"></i>
                            {{ tab.label }}
                        </button>
                    </div>
                </div>

                <!-- Tab Content -->
                <div class="tab-content">
                    <!-- Model Suggestions Tab -->
                    <div v-if="activeTab === 'model_suggestions' && analysisResult.results.model_suggestions" class="space-y-4">
                        <div class="bg-green-50 rounded-lg p-4">
                            <div 
                                class="prose prose-sm max-w-none text-gray-800"
                                v-html="renderMarkdown(getModelSuggestionsContent(analysisResult.results.model_suggestions))"
                            ></div>
                        </div>
                    </div>

                    <!-- Research Plan Tab -->
                    <div v-if="activeTab === 'research_plan' && analysisResult.results.research_plan" class="space-y-4">
                        <div class="bg-purple-50 rounded-lg p-4">
                            <div 
                                class="prose prose-sm max-w-none text-gray-800"
                                v-html="renderMarkdown(extractContentFromNestedObject(analysisResult.results.research_plan))"
                            ></div>
                        </div>
                    </div>

                    <!-- Experiment Design Tab (PLAIN TEXT OUTPUT or fallback to all_designs) -->
                    <div v-if="activeTab === 'experiment_design'" class="space-y-4">
                        <!-- Primary: Use experiment_designs if it's a string -->
                        <div v-if="analysisResult.results.experiment_designs && typeof analysisResult.results.experiment_designs === 'string'" class="bg-indigo-50 rounded-lg p-4">
                            <div 
                                class="prose prose-lg max-w-none text-gray-800"
                                v-html="renderMarkdown(analysisResult.results.experiment_designs)"
                            ></div>
                        </div>
                        
                        <!-- Fallback: Use all_designs array -->
                        <div v-else-if="analysisResult.results.all_designs && analysisResult.results.all_designs.length" class="space-y-6">
                            <div 
                                v-for="(d, idx) in analysisResult.results.all_designs" 
                                :key="idx"
                                class="bg-indigo-50 rounded-lg p-4"
                            >
                                <h3 class="text-xl font-bold text-indigo-700 mb-2">
                                    Experiment {{ idx + 1 }}: 
                                    <span v-if="typeof d.experiment_idea === 'string'">{{ d.experiment_idea }}</span>
                                    <span v-else-if="d.experiment_idea && d.experiment_idea.name">{{ d.experiment_idea.name }}</span>
                                </h3>
                                <div class="prose prose-lg max-w-none text-gray-800" v-html="renderMarkdown(d.design || d.refined_design_content || d.full_design_content || '')"></div>
                            </div>
                        </div>
                        
                        <!-- No content available -->
                        <div v-else class="text-gray-500 italic">No experiment design output available.</div>
                    </div>

                    <!-- Code Tab -->
                    <div v-if="activeTab === 'code'" class="space-y-4">
                        <!-- If code_output is a string -->
                        <div v-if="analysisResult.results.code_output && typeof analysisResult.results.code_output === 'string'" class="bg-gray-50 rounded-lg p-4">
                            <div class="prose prose-lg max-w-none text-gray-800" v-html="renderMarkdown(analysisResult.results.code_output)"></div>
                        </div>
                        <!-- If code is in all_designs array -->
                        <div v-else-if="analysisResult.results.all_designs && analysisResult.results.all_designs.length" class="space-y-6">
                            <div 
                                v-for="(d, idx) in analysisResult.results.all_designs" 
                                :key="idx"
                                class="bg-gray-50 rounded-lg p-4"
                            >
                                <h3 class="text-xl font-bold text-indigo-700 mb-2">
                                    Experiment {{ idx + 1 }}
                                </h3>
                                <div class="prose prose-lg max-w-none text-gray-800" v-html="renderMarkdown(d.design_with_code || d.code_output || '')"></div>
                            </div>
                        </div>
                        <div v-else class="text-gray-500 italic">No code output available.</div>
                    </div>

                    <!-- Experiment Suggestions Tab -->
                    <div v-if="activeTab === 'experiment_suggestions' && analysisResult.results.experiment_suggestions" class="space-y-4">
                        <div class="bg-indigo-50 rounded-lg p-6 border border-indigo-200">
                            <!-- Experiment Suggestions Header -->
                            <div class="flex items-center justify-between mb-6 pb-3 border-b border-indigo-200">
                                <div class="flex items-center">
                                    <i class="fas fa-flask text-2xl text-indigo-600 mr-3"></i>
                                    <div>
                                        <h3 class="text-xl font-bold text-indigo-900">Comprehensive Experiment Plan</h3>
                                        <p class="text-sm text-indigo-600">AI-generated experimental roadmap with detailed recommendations</p>
                                    </div>
                                </div>
                                <div class="flex items-center space-x-2">
                                    <span class="inline-flex items-center px-3 py-1 rounded-full text-xs font-medium bg-indigo-100 text-indigo-800">
                                        <i class="fas fa-chart-line mr-1"></i>
                                        Structured Plan
                                    </span>
                                    <button 
                                        @click="copyExperimentPlan" 
                                        class="px-3 py-1 text-sm bg-indigo-100 text-indigo-700 rounded hover:bg-indigo-200 transition-colors"
                                        title="Copy experiment plan to clipboard"
                                    >
                                        <i class="fas fa-copy mr-1"></i>
                                        Copy Plan
                                    </button>
                                </div>
                            </div>

                            <!-- Quick Summary Cards -->
                            <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6" v-if="getExperimentSummary(analysisResult.results.experiment_suggestions)">
                                <div class="bg-white rounded-lg p-4 border border-indigo-100 shadow-sm">
                                    <div class="flex items-center justify-between">
                                        <div>
                                            <p class="text-sm font-medium text-gray-600">Total Sections</p>
                                            <p class="text-2xl font-bold text-indigo-600">
                                                {{ getExperimentSummary(analysisResult.results.experiment_suggestions).sectionCount }}
                                            </p>
                                        </div>
                                        <i class="fas fa-list-alt text-indigo-400 text-xl"></i>
                                    </div>
                                </div>
                                <div class="bg-white rounded-lg p-4 border border-indigo-100 shadow-sm">
                                    <div class="flex items-center justify-between">
                                        <div>
                                            <p class="text-sm font-medium text-gray-600">Priority Experiments</p>
                                            <p class="text-2xl font-bold text-green-600">
                                                {{ getExperimentSummary(analysisResult.results.experiment_suggestions).priorityCount }}
                                            </p>
                                        </div>
                                        <i class="fas fa-star text-green-400 text-xl"></i>
                                    </div>
                                </div>
                                <div class="bg-white rounded-lg p-4 border border-indigo-100 shadow-sm">
                                    <div class="flex items-center justify-between">
                                        <div>
                                            <p class="text-sm font-medium text-gray-600">Implementation Phases</p>
                                            <p class="text-2xl font-bold text-purple-600">
                                                {{ getExperimentSummary(analysisResult.results.experiment_suggestions).phaseCount }}
                                            </p>
                                        </div>
                                        <i class="fas fa-clock text-purple-400 text-xl"></i>
                                    </div>
                                </div>
                            </div>

                            <!-- Main Content with Enhanced Formatting -->
                            <div class="experiment-suggestions-content">
                                <div 
                                    class="prose prose-lg max-w-none text-gray-800"
                                    v-html="renderExperimentSuggestions(analysisResult.results.experiment_suggestions)"
                                ></div>
                            </div>

                            <!-- Action Buttons -->
                            <div class="mt-8 pt-4 border-t border-indigo-200 flex flex-wrap gap-3">
                                <button
                                    @click="exportExperimentPlan('markdown')"
                                    class="px-4 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 transition-colors"
                                >
                                    <i class="fas fa-download mr-2"></i>
                                    Export as Markdown
                                </button>
                                <button
                                    @click="exportExperimentPlan('pdf')"
                                    class="px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 transition-colors"
                                >
                                    <i class="fas fa-file-pdf mr-2"></i>
                                    Export as PDF
                                </button>
                                <button
                                    @click="scheduleExperiments"
                                    class="px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 transition-colors"
                                >
                                    <i class="fas fa-calendar-alt mr-2"></i>
                                    Create Schedule
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- Quality Assessment Tab -->
                    <div v-if="activeTab === 'quality' && analysisResult.results.critique_results" class="space-y-4">
                        <div class="bg-blue-50 rounded-lg p-4">
                            <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-4" v-if="formatQualityData(analysisResult.results.critique_results).total_score">
                                <div class="text-center">
                                    <div class="text-3xl font-bold text-blue-600">
                                        {{ (formatQualityData(analysisResult.results.critique_results).total_score || 0).toFixed(1) }}
                                    </div>
                                    <div class="text-sm text-gray-600">Overall Score</div>
                                </div>
                            </div>
                            <div class="prose prose-sm max-w-none text-gray-800" v-html="renderMarkdown(formatQualityAssessment(analysisResult.results.critique_results))"></div>
                        </div>
                    </div>

                    <!-- ArXiv Papers Tab -->
                    <div v-if="activeTab === 'arxiv' && analysisResult.results.arxiv_results" class="space-y-4">
                        <div class="bg-orange-50 rounded-lg p-4">
                            <div class="prose prose-sm max-w-none text-gray-800" v-html="renderMarkdown(formatArxivResults(analysisResult.results.arxiv_results))"></div>
                        </div>
                    </div>

                    <!-- Raw JSON Tab -->
                    <div v-if="activeTab === 'raw'" class="space-y-4">
                        <div class="code-block">
                            <pre class="text-xs">{{ JSON.stringify(analysisResult.results, null, 2) }}</pre>
                        </div>
                    </div>
                </div>

                <!-- Export Options -->
                <div class="mt-6 flex items-center space-x-2">
                    <button
                        @click="exportResults('json')"
                        class="px-3 py-1 text-sm bg-gray-100 text-gray-700 rounded hover:bg-gray-200"
                    >
                        <i class="fas fa-download mr-1"></i>
                        Export JSON
                    </button>
                    <button
                        @click="exportResults('txt')"
                        class="px-3 py-1 text-sm bg-gray-100 text-gray-700 rounded hover:bg-gray-200"
                    >
                        <i class="fas fa-file-text mr-1"></i>
                        Export Text
                    </button>
                    <button
                        @click="copyToClipboard"
                        class="px-3 py-1 text-sm bg-gray-100 text-gray-700 rounded hover:bg-gray-200"
                    >
                        <i class="fas fa-copy mr-1"></i>
                        Copy
                    </button>
                </div>
            </div>

            <!-- Analysis History -->
            <div class="card-shadow bg-white rounded-lg p-6">
                <div class="flex items-center justify-between mb-4">
                    <h2 class="text-2xl font-bold text-gray-800">
                        <i class="fas fa-history mr-2"></i>
                        Analysis History
                    </h2>
                    <div class="flex space-x-2">
                        <button
                            @click="clearHistory"
                            class="px-3 py-1 text-red-600 border border-red-600 rounded hover:bg-red-50"
                            v-if="history.length > 0"
                        >
                            <i class="fas fa-trash mr-1"></i>
                            Clear
                        </button>
                        <button
                            @click="loadHistory"
                            class="px-4 py-2 text-purple-600 border border-purple-600 rounded-lg hover:bg-purple-50"
                        >
                            <i class="fas fa-refresh mr-1"></i>
                            Refresh
                        </button>
                    </div>
                </div>

                <div v-if="history.length === 0" class="text-center text-gray-500 py-8">
                    <i class="fas fa-inbox text-4xl mb-2"></i>
                    <p>No analysis history yet. Start by analyzing a research task!</p>
                </div>

                <div v-else class="space-y-3">
                    <div
                        v-for="item in history.slice().reverse()"
                        :key="item.id"
                        class="border border-gray-200 rounded-lg p-4 hover:bg-gray-50 cursor-pointer transition-colors"
                        @click="loadAnalysis(item)"
                    >
                        <div class="flex items-center justify-between">
                            <div class="flex-1">
                                <div class="font-medium text-gray-800 truncate">{{ truncatePrompt(item.prompt) }}</div>
                                <div class="flex items-center space-x-2 mt-1">
                                    <span :class="'workflow-badge ' + getWorkflowClass(item.response?.workflow_type || 'unknown')">
                                        {{ (item.response?.workflow_type || 'unknown').replace('_', ' ') }}
                                    </span>
                                    <span class="text-sm text-gray-500">
                                        {{ formatTimestamp(item.timestamp) }}
                                    </span>
                                </div>
                            </div>
                            <i class="fas fa-chevron-right text-gray-400"></i>
                        </div>
                    </div>
                </div>
            </div>
        </main>

        <!-- Footer -->
        <footer class="bg-gray-800 text-white py-8 mt-12">
            <div class="container mx-auto px-4 text-center">
                <p>&copy; 2025 ML Researcher LangGraph. Powered by LangGraph and FastAPI.</p>
                <div class="mt-2 space-x-4">
                    <span class="text-sm text-gray-400">
                        <i class="fas fa-code mr-1"></i>
                        Built with Vue.js, FastAPI, and LangGraph
                    </span>
                </div>
            </div>
        </footer>
    </div>

    <script>
        const { createApp } = Vue;

        createApp({
            data() {
                return {
                    // Connection settings
                    backendUrl: 'http://localhost:8000',
                    operationMode: 'api', // 'api' or 'demo'
                    connectionStatus: 'status-offline',
                    connectionMessage: 'Not connected',
                    showSettings: false,

                    // Input and analysis
                    prompt: '',
                    streamMode: false,
                    verboseMode: false,
                    isAnalyzing: false,
                    analysisResult: null,
                    analysisLog: [],
                    uploadedFiles: [],
                    
                    // UI state
                    activeTab: 'model_suggestions',
                    history: [],
                    
                    // Example prompts
                    examplePrompts: [
                        {
                            title: "Model Recommendation",
                            text: "What's the best model for image classification with limited data and real-time constraints?",
                            icon: "fas fa-robot",
                            color: "green"
                        },
                        {
                            title: "Research Planning",
                            text: "Generate a comprehensive research plan for improving adversarial robustness in deep learning models",
                            icon: "fas fa-clipboard-list",
                            color: "purple"
                        },
                        {
                            title: "Experiment Suggestions",
                            text: "I've been working on object detection for autonomous vehicles using YOLO. I've achieved 85% mAP on my custom dataset but struggling with small object detection and real-time inference. What additional experiments should I run to improve performance?",
                            icon: "fas fa-flask",
                            color: "indigo"
                        },
                        {
                            title: "Technical Question",
                            text: "How can I optimize transformer models for mobile deployment while maintaining accuracy?",
                            icon: "fas fa-mobile-alt",
                            color: "blue"
                        },
                        {
                            title: "State-of-the-Art",
                            text: "What are the latest developments in federated learning for healthcare applications?",
                            icon: "fas fa-search",
                            color: "orange"
                        }
                    ]
                }
            },
            computed: {
                availableTabs() {
                    if (!this.analysisResult || !this.analysisResult.results) return [];
                    
                    const tabs = [];
                    const results = this.analysisResult.results;
                    
                    if (results.model_suggestions) {
                        tabs.push({ key: 'model_suggestions', label: 'Model Suggestions', icon: 'fas fa-robot' });
                    }
                    if (results.research_plan) {
                        tabs.push({ key: 'research_plan', label: 'Research Plan', icon: 'fas fa-clipboard-list' });
                    }
                    // FIX: Check for experiment_designs field specifically
                    if (results.experiment_designs && typeof results.experiment_designs === 'string' && results.experiment_designs.trim()) {
                        tabs.push({ key: 'experiment_design', label: 'Experiment Design', icon: 'fas fa-list' });
                    }
                    // Alternative: Also check all_designs as fallback
                    else if (results.all_designs && Array.isArray(results.all_designs) && results.all_designs.length > 0) {
                        tabs.push({ key: 'experiment_design', label: 'Experiment Design', icon: 'fas fa-list' });
                    }
                    if (
                        (results.code_output && typeof results.code_output === 'string' && results.code_output.trim()) ||
                        (results.all_designs && results.all_designs.some(d => d.design_with_code && d.design_with_code.trim()))
                    ) {
                        tabs.push({ key: 'code', label: 'Code', icon: 'fas fa-code' });
                    }
                    if (results.experiment_suggestions) {
                        tabs.push({ key: 'experiment_suggestions', label: 'Experiment Suggestions', icon: 'fas fa-flask' });
                    }
                    if (results.critique_results) {
                        tabs.push({ key: 'quality', label: 'Quality Assessment', icon: 'fas fa-star' });
                    }
                    if (results.arxiv_results) {
                        tabs.push({ key: 'arxiv', label: 'ArXiv Papers', icon: 'fas fa-book' });
                    }
                    tabs.push({ key: 'raw', label: 'Raw JSON', icon: 'fas fa-code' });
                    
                    return tabs;
                }
            },
            async mounted() {
                await this.testConnection();
                this.loadLocalHistory();
                
                // Set default active tab
                if (this.availableTabs.length > 0) {
                    this.activeTab = this.availableTabs[0].key;
                }
            },
            methods: {
                truncatePrompt(prompt, maxLen = 180) {
                    if (!prompt) return '';
                    return prompt.length > maxLen ? prompt.slice(0, maxLen) + 'â€¦' : prompt;
                },

                async testConnection() {
                    this.connectionStatus = 'status-connecting';
                    this.connectionMessage = 'Testing connection...';
                    
                    try {
                        const response = await axios.get(`${this.backendUrl}/health`, { timeout: 5000 });
                        this.connectionStatus = 'status-online';
                        this.connectionMessage = 'Connected to backend';
                        this.operationMode = 'api';
                    } catch (error) {
                        console.warn('Backend not available, switching to demo mode:', error.message);
                        this.connectionStatus = 'status-offline';
                        this.connectionMessage = 'Running in demo mode';
                        this.operationMode = 'demo';
                    }
                },

                async analyzeTask() {
                    if (!this.prompt.trim() || this.isAnalyzing) return;

                    this.isAnalyzing = true;
                    this.analysisResult = null;
                    this.analysisLog = [];
                    this.addLog('ðŸ” Starting analysis...');

                    try {
                        if (this.operationMode === 'api') {
                            if (this.uploadedFiles.length > 0) {
                                await this.analyzeWithFiles();
                            } else {
                                await this.analyzeWithAPI();
                            }
                        } else {
                            await this.analyzeWithDemo();
                        }
                    } catch (error) {
                        console.error('Analysis failed:', error);
                        this.addLog(`âŒ Error: ${error.message}`);
                        alert('Analysis failed: ' + error.message);
                    } finally {
                        this.isAnalyzing = false;
                    }
                },

                async analyzeWithAPI() {
                    this.addLog('ðŸš¦ Routing request to appropriate workflow...');
                    
                    const response = await axios.post(`${this.backendUrl}/analyze`, {
                        prompt: this.prompt,
                        stream: this.streamMode
                    });

                    this.addLog('âœ… Analysis completed successfully');
                    this.analysisResult = response.data;
                    
                    // DEBUG: Log the actual structure being received
                    console.log('=== DEBUG: Full response structure ===');
                    console.log('response.data:', response.data);
                    console.log('results:', response.data.results);
                    if (response.data.results.model_suggestions) {
                        console.log('model_suggestions type:', typeof response.data.results.model_suggestions);
                        console.log('model_suggestions:', response.data.results.model_suggestions);
                    }
                    if (response.data.results.research_plan) {
                        console.log('research_plan type:', typeof response.data.results.research_plan);
                        console.log('research_plan:', response.data.results.research_plan);
                    }
                    console.log('=== END DEBUG ===');
                    
                    // Set active tab to first available
                    if (this.availableTabs.length > 0) {
                        this.activeTab = this.availableTabs[0].key;
                    }
                    
                    // Save to local history
                    this.saveToLocalHistory();
                },

                async analyzeWithFiles() {
                    this.addLog('ðŸ“Ž Uploading files and analyzing...');
                    const form = new FormData();
                    form.append('prompt', this.prompt);
                    form.append('stream', this.streamMode ? 'true' : 'false');
                    this.uploadedFiles.forEach(f => form.append('files', f, f.name));

                    const response = await axios.post(`${this.backendUrl}/analyze_with_files`, form, {
                        headers: { 'Content-Type': 'multipart/form-data' },
                        maxBodyLength: Infinity,
                        maxContentLength: Infinity
                    });

                    this.addLog('âœ… Analysis (with files) completed');
                    this.analysisResult = response.data;

                    // Set active tab
                    if (this.availableTabs.length > 0) {
                        this.activeTab = this.availableTabs[0].key;
                    }
                    this.saveToLocalHistory();
                },

                async analyzeWithDemo() {
                    // Simulate different workflow routing based on prompt content
                    this.addLog('ðŸš¦ [DEMO] Analyzing prompt for workflow routing...');
                    await this.delay(1000);

                    let workflowType = 'direct_llm';
                    let routerConfidence = 0.95;
                    let routerReasoning = '';

                    if (this.prompt.toLowerCase().includes('model') || this.prompt.toLowerCase().includes('architecture')) {
                        workflowType = 'model_suggestion';
                        routerReasoning = 'Detected model/architecture recommendation request';
                        this.addLog('ðŸ¤– [DEMO] Routing to Model Suggestion workflow...');
                    } else if (this.prompt.toLowerCase().includes('research') || this.prompt.toLowerCase().includes('plan')) {
                        workflowType = 'research_planning';
                        routerReasoning = 'Detected research planning request';
                        this.addLog('ðŸ“‹ [DEMO] Routing to Research Planning workflow...');
                    } else {
                        routerReasoning = 'General query, using direct LLM response';
                        this.addLog('ðŸ’¬ [DEMO] Routing to Direct LLM workflow...');
                    }

                    await this.delay(1500);

                    // Generate demo results based on workflow type
                    let results = {};
                    
                    if (workflowType === 'model_suggestion') {
                        this.addLog('ðŸ” [DEMO] Searching arXiv papers...');
                        await this.delay(1000);
                        this.addLog('ðŸ¤– [DEMO] Generating model recommendations...');
                        await this.delay(1500);
                        this.addLog('â­ [DEMO] Applying AI critique assessment...');
                        await this.delay(1000);
                        
                        results = {
                            model_suggestions: `# Model Recommendations (Demo Mode)

Based on your query: "${this.prompt}"

## Recommended Models:

### 1. EfficientNet-B0 (Primary Recommendation)
- **Use Case**: Optimal for limited data scenarios with real-time constraints
- **Accuracy**: ~92-94% on standard benchmarks
- **Parameters**: 5.3M (lightweight)
- **Implementation**: Transfer learning from ImageNet pretrained weights

### 2. MobileNetV3-Small (Mobile-Optimized)
- **Use Case**: Extreme resource constraints (mobile/edge devices)
- **Accuracy**: ~89-91% with proper training
- **Parameters**: 2.9M (very lightweight)
- **Implementation**: Quantization-aware training recommended

### 3. Vision Transformer (ViT-Small)
- **Use Case**: If you have some unlabeled data for self-supervision
- **Accuracy**: ~90-93% with self-supervised pretraining
- **Parameters**: 22M (medium size)
- **Implementation**: SimCLR or DINO for pretraining

## Implementation Strategy:
1. Start with EfficientNet-B0 for baseline
2. Apply data augmentation (AutoAugment, Mixup)
3. Use progressive resizing during training
4. Consider knowledge distillation if deployment constraints are critical

*Note: This is a demonstration. For real analysis, use API mode with backend running.*`,
                            arxiv_results: {
                                papers_found: 15,
                                relevant_papers: 8,
                                search_query: "image classification limited data efficient models"
                            },
                            critique_results: {
                                total_score: 8.7,
                                relevance: 9.2,
                                technical_accuracy: 8.8,
                                evidence_utilization: 8.5,
                                completeness: 8.3,
                                summary: "High-quality recommendations with strong evidence base and practical implementation guidance."
                            }
                        };
                    } else if (workflowType === 'research_planning') {
                        this.addLog('ðŸ” [DEMO] Generating research problems...');
                        await this.delay(1000);
                        this.addLog('ðŸŒ [DEMO] Validating with web search...');
                        await this.delay(1500);
                        this.addLog('ðŸ“‹ [DEMO] Creating comprehensive research plan...');
                        await this.delay(1500);
                        this.addLog('â­ [DEMO] Applying AI critique assessment...');
                        await this.delay(1000);
                        
                        results = {
                            research_plan: `# Research Plan: ${this.prompt} (Demo Mode)

## Executive Summary
This research plan addresses the critical challenge of ${this.prompt.toLowerCase()}. The field shows active development with several open problems remaining.

## Phase 1: Literature Review and Foundation (Months 1-2)
- Systematic review of current approaches
- Analysis of existing limitations
- Identification of research gaps

## Phase 2: Problem Formulation (Months 3-4)
- Define specific research objectives
- Establish evaluation metrics
- Design experimental framework

## Phase 3: Method Development (Months 5-8)
- Develop novel approach
- Implement baseline comparisons
- Conduct initial experiments

## Phase 4: Evaluation and Analysis (Months 9-10)
- Comprehensive evaluation
- Statistical analysis of results
- Comparison with state-of-the-art

## Phase 5: Dissemination (Months 11-12)
- Paper writing and submission
- Conference presentation
- Open-source implementation

## Expected Outcomes
- Novel methodology for the identified problem
- Empirical validation and benchmarks
- Open-source tools for the research community

*Note: This is a demonstration. For real analysis, use API mode with backend running.*`,
                            critique_results: {
                                total_score: 8.4,
                                novelty: 8.5,
                                feasibility: 8.8,
                                methodology: 8.2,
                                literature_integration: 8.0,
                                implementation: 8.6,
                                rigor: 8.3,
                                summary: "Well-structured research plan with clear phases and realistic timeline."
                            }
                        };
                    } else {
                        results = {
                            llm_response: `This is a demo response for: "${this.prompt}"

In a real implementation, this would be processed by the direct LLM workflow to provide a comprehensive answer to your question.

To get actual AI-powered analysis, please:
1. Start the backend server: python app.py
2. Ensure the backend URL is correct in settings
3. Test the connection and switch to API mode

*Note: This is a demonstration. For real analysis, use API mode with backend running.*`
                        };
                    }

                    this.addLog('âœ… [DEMO] Analysis completed successfully');
                    
                    this.analysisResult = {
                        workflow_type: workflowType,
                        router_decision: {
                            confidence: routerConfidence,
                            reasoning: routerReasoning
                        },
                        results: results,
                        processing_time: 3.2,
                        timestamp: new Date().toISOString()
                    };
                    
                    // Set active tab to first available
                    if (this.availableTabs.length > 0) {
                        this.activeTab = this.availableTabs[0].key;
                    }
                    
                    // Save to local history
                    this.saveToLocalHistory();
                },

                delay(ms) {
                    return new Promise(resolve => setTimeout(resolve, ms));
                },

                addLog(message) {
                    this.analysisLog.push(`[${new Date().toLocaleTimeString()}] ${message}`);
                    // Auto-scroll to bottom
                    this.$nextTick(() => {
                        const logContainer = document.querySelector('.terminal-output');
                        if (logContainer) {
                            logContainer.scrollTop = logContainer.scrollHeight;
                        }
                    });
                },

                clearAll() {
                    this.prompt = '';
                    this.analysisResult = null;
                    this.analysisLog = [];
                    this.uploadedFiles = [];
                },

                onFilesSelected(e) {
                    const files = Array.from(e.target.files || []);
                    // Basic client-side filter for allowed types
                    const allowed = ['application/vnd.openxmlformats-officedocument.wordprocessingml.document', 'application/msword', 'text/csv', 'application/vnd.ms-excel', 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet'];
                    this.uploadedFiles = files.filter(f => allowed.includes(f.type) || /\.(docx?|csv|xlsx?)$/i.test(f.name));
                },

                clearFiles() {
                    this.uploadedFiles = [];
                },

                saveToLocalHistory() {
                    const historyItem = {
                        id: Date.now(),
                        prompt: this.prompt,
                        response: this.analysisResult,
                        timestamp: new Date().toISOString()
                    };
                    
                    this.history.unshift(historyItem);
                    if (this.history.length > 50) {
                        this.history = this.history.slice(0, 50);
                    }
                    
                    localStorage.setItem('mlresearcher_history', JSON.stringify(this.history));
                },

                loadLocalHistory() {
                    try {
                        const saved = localStorage.getItem('mlresearcher_history');
                        if (saved) {
                            this.history = JSON.parse(saved);
                        }
                    } catch (error) {
                        console.warn('Failed to load local history:', error);
                        this.history = [];
                    }
                },

                clearHistory() {
                    this.history = [];
                    localStorage.removeItem('mlresearcher_history');
                },

                async loadHistory() {
                    if (this.operationMode === 'api') {
                        try {
                            const response = await axios.get(`${this.backendUrl}/history`);
                            this.history = response.data.history;
                        } catch (error) {
                            console.warn('Failed to load server history, using local:', error);
                            this.loadLocalHistory();
                        }
                    } else {
                        this.loadLocalHistory();
                    }
                },

                loadAnalysis(item) {
                    this.analysisResult = item.response;
                    this.prompt = item.prompt;
                    
                    // Set active tab to first available
                    if (this.availableTabs.length > 0) {
                        this.activeTab = this.availableTabs[0].key;
                    }
                    
                    // Scroll to results
                    this.$nextTick(() => {
                        document.querySelector('.result-animation')?.scrollIntoView({ behavior: 'smooth' });
                    });
                },

                getWorkflowClass(workflowType) {
                    const classes = {
                        'model_suggestion': 'model-suggestion',
                        'research_planning': 'research-planning',
                        'direct_llm': 'direct-llm'
                    };
                    return classes[workflowType] || 'unknown';
                },

                getWorkflowIcon(workflowType) {
                    const icons = {
                        'model_suggestion': 'fas fa-robot',
                        'research_planning': 'fas fa-clipboard-list',
                        'direct_llm': 'fas fa-comments'
                    };
                    return icons[workflowType] || 'fas fa-question';
                },

                formatProcessingTime(seconds) {
                    return `${seconds.toFixed(2)}s`;
                },

                formatTimestamp(timestamp) {
                    return new Date(timestamp).toLocaleString();
                },

                formatContent(content) {
                    if (typeof content === 'string') {
                        // Check if the string is actually JSON that needs to be parsed
                        try {
                            // If it's a JSON string, parse and re-stringify it for better formatting
                            if (content.trim().startsWith('{') || content.trim().startsWith('[')) {
                                const parsed = JSON.parse(content);
                                return JSON.stringify(parsed, null, 2);
                            }
                            return content;
                        } catch (e) {
                            // If parsing fails, return as is (it's probably regular text/markdown)
                            return content;
                        }
                    }
                    return JSON.stringify(content, null, 2);
                },

                formatQualityAssessment(data) {
                    // Accept string or object
                    let obj = typeof data === 'string' ? (() => { try { return JSON.parse(data); } catch { return {}; } })() : (data || {});
                    const cd = obj.critique_data || obj.critique || obj;
                    const lines = [];
                    if (obj.total_score != null) {
                        lines.push(`# Quality Assessment\n`);
                        lines.push(`**Overall Score:** ${obj.total_score.toFixed ? obj.total_score.toFixed(1) : obj.total_score}`);
                    } else {
                        lines.push(`# Quality Assessment\n`);
                    }
                    if (cd.overall_quality) lines.push(`**Quality:** ${cd.overall_quality}`);
                    if (cd.confidence != null) lines.push(`**Confidence:** ${cd.confidence}`);

                    const section = (title, arr) => {
                        if (Array.isArray(arr) && arr.length) {
                            lines.push(`\n## ${title}`);
                            arr.forEach(item => lines.push(`- ${item}`));
                        }
                    };
                    section('Strengths', cd.strengths);
                    section('Weaknesses', cd.weaknesses);
                    section('Missing Considerations', cd.missing_considerations || cd["missing_considerations"]);
                    section('Factual Errors', cd.factual_errors);
                    if (cd.evidence_utilization) {
                        lines.push(`\n## Evidence Utilization`);
                        lines.push(cd.evidence_utilization);
                    }
                    if (cd.paper_utilization_analysis) {
                        lines.push(`\n## Paper Utilization`);
                        lines.push(cd.paper_utilization_analysis);
                    }
                    if (cd.recommendation || obj.recommendation) {
                        lines.push(`\n**Recommendation:** ${cd.recommendation || obj.recommendation}`);
                    }
                    return lines.join('\n');
                },

                formatArxivResults(data) {
                    // Summarize papers: show title, id, published, and a short summary (first paragraph, trimmed)
                    const obj = typeof data === 'string' ? (() => { try { return JSON.parse(data); } catch { return {}; } })() : (data || {});
                    const papers = obj.papers || obj.results || [];
                    const total = obj.papers_returned ?? obj.total_results ?? papers.length;
                    const hdr = `# ArXiv Results\n` + (obj.search_query ? `**Query:** ${obj.search_query}\n` : '') + `**Papers Returned:** ${total}\n`;
                    const lines = [hdr];
                    if (!Array.isArray(papers) || papers.length === 0) {
                        lines.push('\n_No papers to display._');
                        return lines.join('\n');
                    }
                    papers.slice(0, 5).forEach((p, idx) => {
                        const title = p.title || 'Untitled';
                        const pid = p.id || p.arxiv_id || '';
                        const pub = p.published || p.date || '';
                        let summary = p.summary || p.abstract || '';
                        if (typeof summary === 'string') {
                            summary = summary.replace(/\n+/g, ' ').trim();
                            if (summary.length > 400) summary = summary.slice(0, 400) + 'â€¦';
                        } else {
                            summary = '';
                        }
                        lines.push(`\n## ${idx + 1}. ${title}`);
                        if (pid) lines.push(`- ID: ${pid}`);
                        if (pub) lines.push(`- Published: ${pub}`);
                        if (summary) lines.push(`- Summary: ${summary}`);
                        if (p.pdf_url || p.link) lines.push(`- PDF: ${p.pdf_url || p.link}`);
                    });
                    if (papers.length > 5) {
                        lines.push(`\n_+${papers.length - 5} more not shownâ€¦_`);
                    }
                    return lines.join('\n');
                },

                formatQualityData(data) {
                    if (typeof data === 'string') {
                        try {
                            return JSON.parse(data);
                        } catch (e) {
                            return data;
                        }
                    }
                    return data;
                },

                renderMarkdown(content) {
                    if (typeof content === 'string') {
                        // Check if content contains markdown formatting
                        if (content.includes('#') || content.includes('**') || content.includes('*') || content.includes('-') || content.includes('1.')) {
                            try {
                                // Configure marked for better security and formatting
                                marked.setOptions({
                                    breaks: true,
                                    gfm: true,
                                    sanitize: false,
                                    smartypants: true
                                });
                                return marked.parse(content);
                            } catch (e) {
                                console.warn('Markdown parsing failed:', e);
                                return `<pre class="whitespace-pre-wrap">${content}</pre>`;
                            }
                        }
                        return `<pre class="whitespace-pre-wrap">${content}</pre>`;
                    }
                    return `<pre class="whitespace-pre-wrap">${this.formatContent(content)}</pre>`;
                },

                getModelSuggestionsContent(modelSuggestions) {
                    // Handle nested model suggestions structure from backend
                    if (typeof modelSuggestions === 'object' && modelSuggestions !== null) {
                        // If it's an object, try to extract the actual content
                        if (modelSuggestions.model_suggestions) {
                            return modelSuggestions.model_suggestions;
                        }
                        if (modelSuggestions.revised_suggestions) {
                            return modelSuggestions.revised_suggestions;
                        }
                        // If it's just the object itself, stringify it
                        return JSON.stringify(modelSuggestions, null, 2);
                    }
                    // If it's already a string, return as is
                    return modelSuggestions || 'No model suggestions available';
                },

                extractContentFromNestedObject(data, contentKeys = ['research_plan', 'model_suggestions', 'content', 'text', 'response']) {
                    // General method to extract actual content from nested backend objects
                    if (typeof data === 'string') {
                        return data;
                    }
                    
                    if (typeof data === 'object' && data !== null) {
                        // Try each potential content key
                        for (const key of contentKeys) {
                            if (data[key] && typeof data[key] === 'string') {
                                return data[key];
                            }
                        }
                        
                        // If no content key found, stringify the object nicely
                        return JSON.stringify(data, null, 2);
                    }
                    
                    return data || 'No content available';
                },

                // Experiment Suggestions specific methods
                renderExperimentSuggestions(experimentData) {
                    // Enhanced markdown rendering specifically for experiment suggestions
                    if (typeof experimentData === 'string') {
                        // Check if content contains markdown formatting
                        if (experimentData.includes('#') || experimentData.includes('**') || experimentData.includes('*')) {
                            try {
                                // Configure marked for better experiment suggestions formatting
                                marked.setOptions({
                                    breaks: true,
                                    gfm: true,
                                    sanitize: false,
                                    smartypants: true,
                                    renderer: this.createExperimentRenderer()
                                });
                                return marked.parse(experimentData);
                            } catch (e) {
                                console.warn('Experiment suggestions markdown parsing failed:', e);
                                return `<pre class="whitespace-pre-wrap">${experimentData}</pre>`;
                            }
                        }
                        return `<pre class="whitespace-pre-wrap">${experimentData}</pre>`;
                    }
                    
                    // Handle object format
                    if (typeof experimentData === 'object' && experimentData !== null) {
                        if (experimentData.experiment_suggestions) {
                            return this.renderExperimentSuggestions(experimentData.experiment_suggestions);
                        }
                        if (experimentData.full_plan) {
                            return this.renderExperimentSuggestions(experimentData.full_plan);
                        }
                        return `<pre class="whitespace-pre-wrap">${JSON.stringify(experimentData, null, 2)}</pre>`;
                    }
                    
                    return '<p class="text-gray-500 italic">No experiment suggestions available</p>';
                },

                createExperimentRenderer() {
                    const renderer = new marked.Renderer();
                    
                    // Custom heading renderer with icons
                    renderer.heading = function(text, level) {
                        const icons = {
                            'Priority Experiments': 'fas fa-star',
                            'Ablation Studies': 'fas fa-cut',
                            'Hyperparameter': 'fas fa-sliders-h',
                            'Architecture': 'fas fa-cogs',
                            'Dataset': 'fas fa-database',
                            'Evaluation': 'fas fa-chart-bar',
                            'Comparative': 'fas fa-balance-scale',
                            'Implementation': 'fas fa-calendar-alt',
                            'Success Metrics': 'fas fa-trophy',
                            'Resource': 'fas fa-dollar-sign',
                            'Risk': 'fas fa-exclamation-triangle'
                        };
                        
                        let icon = 'fas fa-chevron-right';
                        for (const [keyword, iconClass] of Object.entries(icons)) {
                            if (text.toLowerCase().includes(keyword.toLowerCase())) {
                                icon = iconClass;
                                break;
                            }
                        }
                        
                        if (level === 1) {
                            return `<h1 class="text-3xl font-bold text-indigo-900 border-b-2 border-indigo-300 pb-2 mb-4">
                                <i class="${icon} mr-3"></i>${text}
                            </h1>`;
                        } else if (level === 2) {
                            return `<h2 class="text-2xl font-semibold text-gray-800 bg-gradient-to-r from-gray-50 to-gray-100 p-3 border-l-4 border-indigo-500 rounded mb-3 mt-6">
                                <i class="${icon} mr-2 text-indigo-600"></i>${text}
                            </h2>`;
                        } else if (level === 3) {
                            return `<h3 class="text-xl font-medium text-gray-700 bg-gray-50 p-2 border-l-3 border-indigo-400 rounded mb-2 mt-4">
                                <i class="${icon} mr-2 text-indigo-500"></i>${text}
                            </h3>`;
                        } else {
                            return `<h${level} class="text-lg font-medium text-gray-600 mb-2 mt-3">
                                <i class="${icon} mr-1 text-gray-500"></i>${text}
                            </h${level}>`;
                        }
                    };
                    
                    // Custom list renderer with enhanced styling
                    renderer.list = function(body, ordered) {
                        const tag = ordered ? 'ol' : 'ul';
                        const classes = ordered ? 'list-decimal list-inside space-y-2 ml-4' : 'list-disc list-inside space-y-2 ml-4';
                        return `<${tag} class="${classes}">${body}</${tag}>`;
                    };
                    
                    renderer.listitem = function(text) {
                        // Add special styling for priority items
                        if (text.toLowerCase().includes('priority') || text.toLowerCase().includes('important')) {
                            return `<li class="bg-green-50 border-l-2 border-green-400 pl-3 py-1 rounded">${text}</li>`;
                        }
                        // Add special styling for risk items
                        if (text.toLowerCase().includes('risk') || text.toLowerCase().includes('caution')) {
                            return `<li class="bg-yellow-50 border-l-2 border-yellow-400 pl-3 py-1 rounded">${text}</li>`;
                        }
                        return `<li class="py-1">${text}</li>`;
                    };
                    
                    // Custom strong renderer for emphasis
                    renderer.strong = function(text) {
                        if (text.toLowerCase().includes('low')) {
                            return `<strong class="px-2 py-1 bg-green-100 text-green-800 rounded text-sm font-semibold">${text}</strong>`;
                        }
                        if (text.toLowerCase().includes('medium')) {
                            return `<strong class="px-2 py-1 bg-yellow-100 text-yellow-800 rounded text-sm font-semibold">${text}</strong>`;
                        }
                        if (text.toLowerCase().includes('high')) {
                            return `<strong class="px-2 py-1 bg-red-100 text-red-800 rounded text-sm font-semibold">${text}</strong>`;
                        }
                        return `<strong class="font-semibold text-gray-900">${text}</strong>`;
                    };
                    
                    return renderer;
                },

                getExperimentSummary(experimentData) {
                    // Extract summary statistics from experiment suggestions
                    let content = '';
                    if (typeof experimentData === 'string') {
                        content = experimentData;
                    } else if (typeof experimentData === 'object' && experimentData !== null) {
                        content = experimentData.experiment_suggestions || experimentData.full_plan || JSON.stringify(experimentData);
                    }
                    
                    if (!content) return { sectionCount: 0, priorityCount: 0, phaseCount: 0 };
                    
                    // Count sections (## headers)
                    const sectionMatches = content.match(/^##\s+/gm) || [];
                    const sectionCount = sectionMatches.length;
                    
                    // Count priority experiments
                    const priorityMatches = content.match(/priority|important/gi) || [];
                    const priorityCount = Math.min(priorityMatches.length, 10); // Cap at 10
                    
                    // Count implementation phases
                    const phaseMatches = content.match(/phase\s+\d+|step\s+\d+/gi) || [];
                    const phaseCount = Math.max(phaseMatches.length, 3); // Default to 3 phases
                    
                    return {
                        sectionCount,
                        priorityCount,
                        phaseCount
                    };
                },

                copyExperimentPlan() {
                    if (!this.analysisResult || !this.analysisResult.results.experiment_suggestions) {
                        alert('No experiment plan to copy');
                        return;
                    }
                    
                    let content = this.analysisResult.results.experiment_suggestions;
                    if (typeof content === 'object') {
                        content = content.experiment_suggestions || content.full_plan || JSON.stringify(content, null, 2);
                    }
                    
                    navigator.clipboard.writeText(content).then(() => {
                        // Show temporary success message
                        const originalText = event.target.innerHTML;
                        event.target.innerHTML = '<i class="fas fa-check mr-1"></i>Copied!';
                        event.target.classList.add('bg-green-600');
                        setTimeout(() => {
                            event.target.innerHTML = originalText;
                            event.target.classList.remove('bg-green-600');
                        }, 2000);
                    }).catch(err => {
                        console.error('Failed to copy: ', err);
                        alert('Failed to copy experiment plan to clipboard');
                    });
                },

                exportExperimentPlan(format) {
                    if (!this.analysisResult || !this.analysisResult.results.experiment_suggestions) {
                        alert('No experiment plan to export');
                        return;
                    }
                    
                    let content = this.analysisResult.results.experiment_suggestions;
                    if (typeof content === 'object') {
                        content = content.experiment_suggestions || content.full_plan || JSON.stringify(content, null, 2);
                    }
                    
                    const timestamp = new Date().toISOString().replace(/[:.]/g, '-');
                    const filename = `experiment-plan-${timestamp}`;
                    
                    if (format === 'markdown') {
                        this.downloadFile(content, `${filename}.md`, 'text/markdown');
                    } else if (format === 'pdf') {
                        // For PDF export, we'd need a PDF library, so for now just show a message
                        alert('PDF export functionality would require additional PDF generation library. For now, please copy the content and paste into a document editor.');
                    }
                },

                scheduleExperiments() {
                    if (!this.analysisResult || !this.analysisResult.results.experiment_suggestions) {
                        alert('No experiment plan to schedule');
                        return;
                    }
                    
                    // This would integrate with calendar or project management tools
                    alert('Experiment scheduling functionality would integrate with calendar or project management tools. For now, please manually schedule the experiments from the plan.');
                },

                downloadFile(content, filename, mimeType) {
                    const blob = new Blob([content], { type: mimeType });
                    const url = window.URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = filename;
                    document.body.appendChild(a);
                    a.click();
                    window.URL.revokeObjectURL(url);
                    document.body.removeChild(a);
                },

                exportResults(format) {
                    if (!this.analysisResult) return;

                    const timestamp = new Date().toISOString().replace(/[:.]/g, '-');
                    const filename = `ml_research_analysis_${timestamp}.${format}`;
                    
                    let content;
                    let mimeType;
                    
                    if (format === 'json') {
                        content = JSON.stringify(this.analysisResult, null, 2);
                        mimeType = 'application/json';
                    } else if (format === 'txt') {
                        content = `ML Research Analysis Results
Generated: ${new Date().toLocaleString()}
Prompt: ${this.prompt}

Workflow: ${this.analysisResult.workflow_type}
Router Confidence: ${(this.analysisResult.router_decision?.confidence * 100).toFixed(1)}%

Results:
${this.formatContent(this.analysisResult.results)}`;
                        mimeType = 'text/plain';
                    }
                    
                    const blob = new Blob([content], { type: mimeType });
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = filename;
                    a.click();
                    URL.revokeObjectURL(url);
                },

                async copyToClipboard() {
                    if (!this.analysisResult) return;
                    
                    const content = this.formatContent(this.analysisResult.results);
                    
                    try {
                        await navigator.clipboard.writeText(content);
                        // Show brief success indicator
                        const button = event.target;
                        const originalContent = button.innerHTML;
                        button.innerHTML = '<i class="fas fa-check mr-1"></i>Copied!';
                        setTimeout(() => {
                            button.innerHTML = originalContent;
                        }, 1500);
                    } catch (error) {
                        console.error('Failed to copy to clipboard:', error);
                        alert('Failed to copy to clipboard');
                    }
                }
            }
        }).mount('#app');
    </script>
</body>
</html>
