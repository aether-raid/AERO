graph TD
    A[ğŸ”¬ Research Planning Start] --> B[ğŸ¯ Generate Problem Statement<br/>Iteration: 1]
    
    B --> C[ğŸŒ Validate Problem<br/>Web Search + LLM Analysis]
    C --> D{ğŸ¤” Problem Assessment<br/>Solved vs Open}
    
    D -->|âœ… Open/Novel<br/>Accept| E[ğŸ“¥ Collect Problem<br/>Add to Validated List]
    D -->|âŒ Solved/Well-studied<br/>Reject| F[ğŸ”„ Generate New Problem<br/>Iteration: N+1]
    
    E --> G{ğŸ“Š Collection Check<br/>Have Enough Problems?}
    G -->|âŒ Need More<br/>< 3 Problems| F
    G -->|âœ… Sufficient<br/>â‰¥ 3 Problems| H[ï¿½ Select Problem<br/>User Choice Interface]
    
    F --> I{â° Iteration Limit<br/>< 10 Attempts?}
    I -->|âœ… Continue| B
    I -->|âŒ Max Reached| H
    
    H --> J[ğŸ“‹ Create Research Plan<br/>Comprehensive Analysis]
    
    %% NEW: Critique and Refinement Loop
    J --> K[ğŸ” Critique Plan<br/>AI Quality Assessment]
    
    K --> L{ğŸ“Š Quality Check<br/>Major Issues?}
    
    L -->|ğŸ‰ No Major Issues<br/>High Quality| M[âœ… Finalize Plan<br/>Quality Approved]
    L -->|ğŸ”„ Has Major Issues<br/>Refinable| N[ğŸ”§ Refinement Context<br/>Add Critique Feedback]
    L -->|âš ï¸ Problem Issues<br/>Fundamental Problems| H
    L -->|ğŸ”„ Deep Issues<br/>Start Over| B
    
    N --> O{ğŸ”„ Refinement Check<br/>< 3 Attempts?}
    O -->|âœ… Continue Refining| J
    O -->|âŒ Max Refinements| P[âœ… Accept Best Version<br/>Force Finalize]
    
    %% Validation Details
    C --> C1[ğŸ“š Literature Check]
    C --> C2[ğŸŒ Web Search Results]  
    C --> C3[ğŸ¯ Gap Assessment]
    
    %% Problem Generation Details
    B --> B1[ğŸ’­ Domain Exploration]
    B --> B2[ğŸ” Challenge Identification]
    B --> B3[â“ Question Formulation]
    
    %% Critique Details
    K --> K1[ğŸ“Š Novelty Assessment]
    K --> K2[ğŸ”§ Feasibility Check]
    K --> K3[ğŸ“ Methodology Review]
    K --> K4[â° Timeline Validation]
    
    %% Research Plan Details
    J --> J1[ğŸ“‹ Problem Analysis]
    J --> J2[â° Phase Planning]
    J --> J3[ğŸ’° Resource Estimation]
    J --> J4[ğŸ“Š Success Metrics]
    
    %% Styling
    classDef start fill:#FFE4B5,stroke:#FF8C00,stroke-width:2px
    classDef process fill:#45B7D1,stroke:#007BFF,stroke-width:2px
    classDef validation fill:#96CEB4,stroke:#28A745,stroke-width:2px
    classDef decision fill:#FECA57,stroke:#F39C12,stroke-width:2px
    classDef collection fill:#DDA0DD,stroke:#8A2BE2,stroke-width:2px
    classDef userAction fill:#FF6B6B,stroke:#DC143C,stroke-width:2px
    classDef critique fill:#9370DB,stroke:#663399,stroke-width:2px
    classDef refinement fill:#FFA07A,stroke:#FF4500,stroke-width:2px
    classDef output fill:#90EE90,stroke:#32CD32,stroke-width:3px
    classDef subprocess fill:#F0F8FF,stroke:#4682B4,stroke-width:1px
    classDef loop fill:#FFB6C1,stroke:#DC143C,stroke-width:2px
    
    class A start
    class B,F process
    class C validation
    class D,G,I,L,O decision
    class E collection
    class H userAction
    class J,M,P output
    class K critique
    class N refinement
    class B1,B2,B3,C1,C2,C3,J1,J2,J3,J4,K1,K2,K3,K4 subprocess
    class F,N loop