graph TD
    A[📋 Research Plan Generated] --> B[🔍 Critique Agent<br/>Quality Assessment]
    
    B --> C[📊 Multi-Dimensional Analysis<br/>6 Evaluation Criteria]
    
    C --> D[🎯 Novelty & Impact<br/>25% Weight]
    C --> E[🔧 Technical Feasibility<br/>20% Weight]
    C --> F[📝 Methodology Soundness<br/>20% Weight]
    C --> G[📚 Literature Integration<br/>15% Weight]
    C --> H[⚙️ Practical Implementation<br/>10% Weight]
    C --> I[🎓 Academic Rigor<br/>10% Weight]
    
    D --> J[📊 Scoring & Analysis<br/>1-10 Scale Each]
    E --> J
    F --> J
    G --> J
    H --> J
    I --> J
    
    J --> K{🔍 Issue Analysis<br/>Major Issues Found?}
    
    K -->|🎉 No Major Issues<br/>Clean Plan| L[✅ Finalize Plan<br/>Quality Approved]
    K -->|⚠️ 1-2 Major Issues<br/>Refinable| M[🔧 Refinement Mode<br/>Add Critique Context]
    K -->|❌ 3+ Major Issues<br/>Fundamental Problems| N{🔄 Refinement Count<br/>< 3 Attempts?}
    
    M --> O[📝 Enhanced Prompt<br/>Previous Plan + Issues]
    O --> P[🔄 Regenerate Plan<br/>Same Node, New Context]
    P --> B
    
    N -->|✅ Try Again| Q[👤 Select Different Problem<br/>Back to Selection]
    N -->|❌ Max Attempts| R[✅ Accept Best Version<br/>Force Finalize]
    
    %% Refinement Context Details
    O --> O1[📋 Previous Plan Content]
    O --> O2[⚠️ Specific Issues List]
    O --> O3[💡 Improvement Suggestions]
    O --> O4[✅ Strengths to Preserve]
    
    %% Evaluation Criteria Details
    D --> D1[🔬 Research Significance]
    D --> D2[🆕 Novel Contributions]
    
    E --> E1[💰 Resource Feasibility]
    E --> E2[⏰ Timeline Realism]
    
    F --> F1[🧪 Experimental Design]
    F --> F2[📊 Success Metrics]
    
    G --> G1[🌐 Web Search Usage]
    G --> G2[📄 Citation Quality]
    
    H --> H1[🗂️ Phase Structure]
    H --> H2[🎯 Clear Milestones]
    
    I --> I1[📑 Publication Strategy]
    I --> I2[🏆 Impact Assessment]
    
    %% Iteration Tracking
    M -.->|Track Refinements| S[📈 Refinement Counter<br/>Max: 3 Iterations]
    B -.->|Score History| T[📊 Score Improvement<br/>Must Improve ≥0.3]
    
    %% Final Outputs
    L --> U[📄 Final Plan<br/>With Quality Score]
    R --> V[📄 Best Attempt<br/>With Refinement History]
    
    %% Styling
    classDef generation fill:#4ECDC4,stroke:#17A2B8,stroke-width:2px
    classDef critique fill:#9370DB,stroke:#663399,stroke-width:2px
    classDef evaluation fill:#DDA0DD,stroke:#8A2BE2,stroke-width:2px
    classDef decision fill:#FECA57,stroke:#F39C12,stroke-width:2px
    classDef refinement fill:#FFA07A,stroke:#FF4500,stroke-width:2px
    classDef success fill:#90EE90,stroke:#32CD32,stroke-width:2px
    classDef context fill:#F0F8FF,stroke:#4682B4,stroke-width:1px
    classDef tracking fill:#FFE4E1,stroke:#CD5C5C,stroke-width:1px
    
    class A,P generation
    class B,C,J critique
    class D,E,F,G,H,I evaluation
    class K,N decision
    class M,O refinement
    class L,R,U,V success
    class D1,D2,E1,E2,F1,F2,G1,G2,H1,H2,I1,I2,O1,O2,O3,O4 context
    class S,T tracking