graph TD
    A[ğŸ“‹ Research Plan Generated] --> B[ğŸ” Critique Agent<br/>Quality Assessment]
    
    B --> C[ğŸ“Š Multi-Dimensional Analysis<br/>6 Evaluation Criteria]
    
    C --> D[ğŸ¯ Novelty & Impact<br/>25% Weight]
    C --> E[ğŸ”§ Technical Feasibility<br/>20% Weight]
    C --> F[ğŸ“ Methodology Soundness<br/>20% Weight]
    C --> G[ğŸ“š Literature Integration<br/>15% Weight]
    C --> H[âš™ï¸ Practical Implementation<br/>10% Weight]
    C --> I[ğŸ“ Academic Rigor<br/>10% Weight]
    
    D --> J[ğŸ“Š Scoring & Analysis<br/>1-10 Scale Each]
    E --> J
    F --> J
    G --> J
    H --> J
    I --> J
    
    J --> K{ğŸ” Issue Analysis<br/>Major Issues Found?}
    
    K -->|ğŸ‰ No Major Issues<br/>Clean Plan| L[âœ… Finalize Plan<br/>Quality Approved]
    K -->|âš ï¸ 1-2 Major Issues<br/>Refinable| M[ğŸ”§ Refinement Mode<br/>Add Critique Context]
    K -->|âŒ 3+ Major Issues<br/>Fundamental Problems| N{ğŸ”„ Refinement Count<br/>< 3 Attempts?}
    
    M --> O[ğŸ“ Enhanced Prompt<br/>Previous Plan + Issues]
    O --> P[ğŸ”„ Regenerate Plan<br/>Same Node, New Context]
    P --> B
    
    N -->|âœ… Try Again| Q[ğŸ‘¤ Select Different Problem<br/>Back to Selection]
    N -->|âŒ Max Attempts| R[âœ… Accept Best Version<br/>Force Finalize]
    
    %% Refinement Context Details
    O --> O1[ğŸ“‹ Previous Plan Content]
    O --> O2[âš ï¸ Specific Issues List]
    O --> O3[ğŸ’¡ Improvement Suggestions]
    O --> O4[âœ… Strengths to Preserve]
    
    %% Evaluation Criteria Details
    D --> D1[ğŸ”¬ Research Significance]
    D --> D2[ğŸ†• Novel Contributions]
    
    E --> E1[ğŸ’° Resource Feasibility]
    E --> E2[â° Timeline Realism]
    
    F --> F1[ğŸ§ª Experimental Design]
    F --> F2[ğŸ“Š Success Metrics]
    
    G --> G1[ğŸŒ Web Search Usage]
    G --> G2[ğŸ“„ Citation Quality]
    
    H --> H1[ğŸ—‚ï¸ Phase Structure]
    H --> H2[ğŸ¯ Clear Milestones]
    
    I --> I1[ğŸ“‘ Publication Strategy]
    I --> I2[ğŸ† Impact Assessment]
    
    %% Iteration Tracking
    M -.->|Track Refinements| S[ğŸ“ˆ Refinement Counter<br/>Max: 3 Iterations]
    B -.->|Score History| T[ğŸ“Š Score Improvement<br/>Must Improve â‰¥0.3]
    
    %% Final Outputs
    L --> U[ğŸ“„ Final Plan<br/>With Quality Score]
    R --> V[ğŸ“„ Best Attempt<br/>With Refinement History]
    
    %% Styling
    classDef generation fill:#4ECDC4,stroke:#17A2B8,stroke-width:2px
    classDef critique fill:#9370DB,stroke:#663399,stroke-width:2px
    classDef evaluation fill:#DDA0DD,stroke:#8A2BE2,stroke-width:2px
    classDef decision fill:#FECA57,stroke:#F39C12,stroke-width:2px
    classDef refinement fill:#FFA07A,stroke:#FF4500,stroke-width:2px
    classDef success fill:#90EE90,stroke:#32CD32,stroke-width:2px
    classDef context fill:#F0F8FF,stroke:#4682B4,stroke-width:1px
    classDef tracking fill:#FFE4E1,stroke:#CD5C5C,stroke-width:1px
    
    class A,P generation
    class B,C,J critique
    class D,E,F,G,H,I evaluation
    class K,N decision
    class M,O refinement
    class L,R,U,V success
    class D1,D2,E1,E2,F1,F2,G1,G2,H1,H2,I1,I2,O1,O2,O3,O4 context
    class S,T tracking