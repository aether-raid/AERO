import asyncio
from langgraph.graph import StateGraph, END
import sys
import os
import re
sys.path.insert(0, os.path.abspath(os.path.join(os.path.dirname(__file__), '..')))
from design_experiment.experiment import ExperimentState, build_experiment_graph
from design_experiment.init_utils import extract_research_components
from design_experiment.idea_tree import run_experiment_tree_search
from design_experiment.code import build_codegen_graph, CodeGenState

# --- Node: Extract research components ---
async def node_extract_components(state):
    user_input = state['user_input']
    print("üîé Extracting research components...")
    result = await extract_research_components(user_input)
    state['research_goal'] = result.get('research_goal', '')
    state['hypotheses'] = result.get('hypotheses', [])
    state['variables'] = result.get('variables', '')
    state['relevant_info'] = result.get('relevant_info', '')
    state['experiment_ideas'] = result.get('experiment_ideas', [])
    return state

# --- Helper Function: Enables Links ---
def add_arxiv_links(text):
    # Replace (arxiv_id) with ([arxiv.org/pdf/arxiv_id](https://arxiv.org/pdf/arxiv_id))
    def repl(match):
        arxiv_id = match.group(1)
        url = f"https://arxiv.org/pdf/{arxiv_id}"
        return f"([{url}]({url}))"
    # Only replace IDs that look like arXiv IDs (e.g., 1912.07812v4)
    return re.sub(r'\((\d{4}\.\d{5}(v\d+)?)\)', repl, text)


# --- Node: For each experiment idea, run experiment design workflow ---
async def node_run_experiment_design(state):
    experiment_ideas = state.get('experiment_ideas', [])
    research_goal = state.get('research_goal', '')
    hypotheses = state.get('hypotheses', [])
    variables = state.get('variables', '')
    relevant_info = state.get('relevant_info', '')

    all_designs = []
    print(f"üß™ Found {len(experiment_ideas)} experiment idea(s). Generating detailed designs...")
    for idx, exp in enumerate(experiment_ideas, 1):
        print(f"\n=== Experiment Idea {idx} ===")
        exp_desc = exp.get('description', exp) if isinstance(exp, dict) else str(exp)
        experiment_input = f"""Research Goal: {research_goal}
            Hypotheses: {', '.join(hypotheses) if hypotheses else 'N/A'}
            Variables: {variables}
            Relevant Info: {relevant_info}
            Experiment Idea: {exp_desc}
            """
        initial_state = ExperimentState(user_input=experiment_input.strip())
        app = build_experiment_graph()
        final_state_dict = await app.ainvoke(initial_state)
        final_state = ExperimentState(**final_state_dict)
        design_text = final_state.refined_design_content or final_state.full_design_content

        # --- Add arXiv links to references ---
        design_text = add_arxiv_links(design_text)

        # --- Retrieve code generated by the experiment graph ---
        final_design_with_code = final_state.generated_code if hasattr(final_state, "generated_code") else ""

        all_designs.append({
            "experiment_idea": exp_desc,
            "design": design_text,
            "refinements": final_state.refinement_suggestions,
            "code": final_design_with_code  # <-- Use this key for code output
        })
        print("\n--- FINAL EXPERIMENT DESIGN WITH INLINE CODE ---")
        print(final_design_with_code)
        print("\n--- FINAL REFINEMENT SUGGESTIONS ---")
        if final_state.refinement_suggestions:
            for s in final_state.refinement_suggestions:
                print(f"- {s.strip('- ')}")
    state['all_designs'] = all_designs
    return state

# --- Node: Run tree search if no experiment ideas ---
async def node_tree_search(state):
    research_goal = state.get('research_goal', '')
    hypotheses = state.get('hypotheses', [])
    variables = state.get('variables', '')
    relevant_info = state.get('relevant_info', '')

    tree_search_results = []
    all_designs = []

    if isinstance(hypotheses, list) and len(hypotheses) >= 2:
        print(f"üå≥ Multiple hypotheses found ({len(hypotheses)}). Running tree search for each hypothesis...")
        for idx, hypothesis in enumerate(hypotheses, 1):
            print(f"\n--- Tree Search for Hypothesis {idx}: {hypothesis} ---")
            combined_input = f"""Research Goal: {research_goal}
                Variables: {variables}
                Relevant Info: {relevant_info}
                Hypotheses: {hypothesis}
                """
            best_methodology = await run_experiment_tree_search(combined_input, num_iterations=5)
            if best_methodology:
                print("\n--- BEST EXPERIMENT DESIGN (TREE SEARCH) ---")
                print(best_methodology.content)
                tree_search_results.append({
                    "hypothesis": hypothesis,
                    "best_methodology": best_methodology.content
                })
                # Now run build_experiment_graph using this methodology as the experiment idea
                experiment_input = f"""Research Goal: {research_goal}
                    Hypotheses: {hypothesis}
                    Variables: {variables}
                    Relevant Info: {relevant_info}
                    Experiment Idea: {best_methodology.content}
                    """
                initial_state = ExperimentState(user_input=experiment_input.strip())
                app = build_experiment_graph()
                final_state_dict = await app.ainvoke(initial_state)
                final_state = ExperimentState(**final_state_dict)
                design_text = final_state.refined_design_content or final_state.full_design_content

                # --- INTEGRATION: Run code workflow on the design text ---
                if design_text:
                    code_state = CodeGenState(user_input=design_text)
                    code_graph = build_codegen_graph()
                    final_code_state = await code_graph.ainvoke(code_state)
                    if isinstance(final_code_state, dict):
                        final_design_with_code = final_code_state.get('final_output', design_text)
                    else:
                        final_design_with_code = getattr(final_code_state, 'final_output', design_text)
                else:
                    final_design_with_code = "‚ùå No valid experiment design available for code generation."

                all_designs.append({
                    "hypothesis": hypothesis,
                    "experiment_idea": best_methodology.content,
                    "design": design_text,
                    "refinements": final_state.refinement_suggestions,
                    "design_with_code": final_design_with_code
                })
                print("\n--- FINAL EXPERIMENT DESIGN WITH INLINE CODE ---")
                print(final_design_with_code)
                print("\n--- FINAL REFINEMENT SUGGESTIONS ---")
                if final_state.refinement_suggestions:
                    for s in final_state.refinement_suggestions:
                        print(f"- {s.strip('- ')}")
    else:
        print("üå≥ No explicit experiment ideas found. Running tree search to generate experiment ideas based on hypotheses...")
        combined_input = f"""Research Goal: {research_goal}
            Variables: {variables}
            Relevant Info: {relevant_info}
            Hypotheses: {', '.join(hypotheses) if hypotheses else 'N/A'}
            """
        best_methodology = await run_experiment_tree_search(combined_input, num_iterations=7)
        if best_methodology:
            tree_search_results.append({
                "hypothesis": hypotheses[0] if hypotheses else 'N/A',
                "best_methodology": best_methodology.content
            })
            experiment_input = f"""Research Goal: {research_goal}
                Hypotheses: {hypotheses[0] if hypotheses else 'N/A'}
                Variables: {variables}
                Relevant Info: {relevant_info}
                Experiment Idea: {best_methodology.content}
                """
            initial_state = ExperimentState(user_input=experiment_input.strip())
            app = build_experiment_graph()
            final_state_dict = await app.ainvoke(initial_state)
            final_state = ExperimentState(**final_state_dict)
            design_text = final_state.refined_design_content or final_state.full_design_content

            # --- INTEGRATION: Run code workflow on the design text ---
            if design_text:
                code_state = CodeGenState(user_input=design_text)
                code_graph = build_codegen_graph()
                final_code_state = await code_graph.ainvoke(code_state)
                if isinstance(final_code_state, dict):
                    final_design_with_code = final_code_state.get('final_output', design_text)
                else:
                    final_design_with_code = getattr(final_code_state, 'final_output', design_text)
            else:
                final_design_with_code = "‚ùå No valid experiment design available for code generation."

            all_designs.append({
                "hypothesis": hypotheses[0] if hypotheses else 'N/A',
                "experiment_idea": best_methodology.content,
                "design": design_text,
                "refinements": final_state.refinement_suggestions,
                "design_with_code": final_design_with_code
            })
            print("\n--- FINAL EXPERIMENT DESIGN WITH INLINE CODE ---")
            print(final_design_with_code)
            print("\n--- FINAL REFINEMENT SUGGESTIONS ---")
            if final_state.refinement_suggestions:
                for s in final_state.refinement_suggestions:
                    print(f"- {s.strip('- ')}")

    state['tree_search_result'] = tree_search_results
    state['all_designs'] = all_designs
    return state

# --- Conditional edge: decide which path to take ---
async def decide_next_node(state):
    if state.get('experiment_ideas'):
        return 'run_experiment_design'
    else:
        return 'tree_search'

# --- Build LangGraph workflow ---
def design_experiment_workflow():
    g = StateGraph(dict)
    g.add_node('extract_components', node_extract_components)
    g.add_node('run_experiment_design', node_run_experiment_design)
    g.add_node('tree_search', node_tree_search)
    g.add_conditional_edges('extract_components', decide_next_node)
    g.add_edge('run_experiment_design', END)
    g.add_edge('tree_search', END)
    g.set_entry_point('extract_components')
    return g

async def main():
    print("Paste your full research plan (end with an empty line):")
    user_input = ""
    while True:
        line = input()
        if line.strip() == "":
            break
        user_input += line + "\n"

    workflow = design_experiment_workflow()
    state = {'user_input': user_input}
    app = workflow.compile()
    await app.ainvoke(state)

if __name__ == "__main__":
    asyncio.run(main())